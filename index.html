<script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbxn7MFQXEwDgyDp7CuQshI_hbK6lTzsFMVkeufx6bGueXlMHySZghTclNCoSkzYEtuc/exec';

  function sendToSheet(code) {
    fetch(scriptURL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ bottle: code })
    })
    .then(res => res.json())
    .then(data => {
      const msg = `📦 ${code} → ${data.duplicate === "是" ? "❗️重複" : "✅成功"}`;
      document.getElementById('result').innerHTML = msg;
    })
    .catch(err => {
      document.getElementById('result').innerHTML = "❌ 傳送失敗：" + err;
    });
  }

  const scanner = new Html5Qrcode("reader");

  function startScanner() {
    scanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText, decodedResult) => {
        sendToSheet(decodedText);
        scanner.stop();
        setTimeout(() => {
          document.getElementById('result').innerText = "📱 請掃描貼紙...";
          startScanner(); // 重新啟動掃描器
        }, 1500);
      },
      (errorMessage) => {
        // 可忽略錯誤
      }
    );
  }

  document.addEventListener("DOMContentLoaded", startScanner);
</script>
