<script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbxn7MFQXEwDgyDp7CuQshI_hbK6lTzsFMVkeufx6bGueXlMHySZghTclNCoSkzYEtuc/exec';

  function sendToSheet(code) {
    fetch(scriptURL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ bottle: code })
    })
    .then(res => res.json())
    .then(data => {
      const msg = `ğŸ“¦ ${code} â†’ ${data.duplicate === "æ˜¯" ? "â—ï¸é‡è¤‡" : "âœ…æˆåŠŸ"}`;
      document.getElementById('result').innerHTML = msg;
    })
    .catch(err => {
      document.getElementById('result').innerHTML = "âŒ å‚³é€å¤±æ•—ï¼š" + err;
    });
  }

  const scanner = new Html5Qrcode("reader");

  function startScanner() {
    scanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText, decodedResult) => {
        sendToSheet(decodedText);
        scanner.stop();
        setTimeout(() => {
          document.getElementById('result').innerText = "ğŸ“± è«‹æƒæè²¼ç´™...";
          startScanner(); // é‡æ–°å•Ÿå‹•æƒæå™¨
        }, 1500);
      },
      (errorMessage) => {
        // å¯å¿½ç•¥éŒ¯èª¤
      }
    );
  }

  document.addEventListener("DOMContentLoaded", startScanner);
</script>
